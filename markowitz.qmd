---
title: "Modelo de Markowitz"
format: 
  html:
    css: styles_markowitz.css   # CSS exclusivo para este arquivo 
execute:
  echo: false
---

## üìä Otimiza√ß√£o de Carteira 


### üìà O que √©?
O modelo de Markowitz, tamb√©m chamado de Teoria Moderna de Portf√≥lios, busca construir uma carteira de ativos que ofere√ßa o melhor equil√≠brio poss√≠vel entre risco e retorno.

### ‚öôÔ∏è Como funciona o modelo?
#### Entradas principais:

üî∏ Retorno esperado de cada ativo

üî∏ Matriz de covari√¢ncia dos retornos (risco e correla√ß√£o entre os ativos)

O objetivo do modelo √©: Minimizar a volatilidade (risco) da carteira

#### Sujeito a:

‚úÖ O retorno da carteira ser igual a um alvo (target_return)

‚úÖ A soma dos pesos ser igual a 1 (100% do capital investido)

‚úÖ (Opcional) Pesos ‚â• 0 ‚Üí n√£o permite venda a descoberto (short)



### ‚ö†Ô∏è Por que a a√ß√£o STLA ficou com peso zero?
‚Üí Isso acontece quando o algoritmo entende que incluir STLA n√£o ajuda a melhorar o equil√≠brio risco-retorno da carteira. As raz√µes t√≠picas s√£o:

‚úîÔ∏è 1. Retorno ajustado ao risco ruim
STLA tem um retorno esperado baixo para o n√≠vel de risco que apresenta, quando comparada √†s outras a√ß√µes.

‚úîÔ∏è 2. Alta correla√ß√£o com outras a√ß√µes
Se a STLA est√° muito correlacionada, por exemplo, com GM ou TM, o modelo pode preferir esses ativos que entregam um retorno/riscos melhor.

‚úîÔ∏è 3. Solu√ß√£o de Canto (Corner Solution)
Em otimiza√ß√µes com a restri√ß√£o de peso ‚â• 0, √© comum que alguns ativos sejam eliminados da carteira (peso zero), porque eles n√£o s√£o necess√°rios para atingir o retorno desejado da forma mais eficiente poss√≠vel.

### üìä Analogia simples:
Imagine montar um time de futebol. Se dois jogadores fazem exatamente a mesma fun√ß√£o, voc√™ n√£o escala os dois ‚Äî escolhe aquele que faz melhor com menor custo. O Markowitz faz isso, s√≥ que com risco e retorno.

### üî• Conclus√£o pr√°tica:
O modelo n√£o diz que STLA √© uma m√° a√ß√£o isoladamente.

Ele diz que, dado o retorno desejado e as caracter√≠sticas estat√≠sticas (volatilidade e correla√ß√£o), a STLA n√£o melhora a carteira no ponto √≥timo escolhido.

Se voc√™ mudar o target_return ou permitir vendas a descoberto, pode ser que ela entre na carteira.



```{r , include=FALSE}
# üì¶ Pacotes necess√°rios
library(tidyquant)
library(tidyverse)
library(quadprog)
library(PerformanceAnalytics)

# üîó Definir os tickers das 5 a√ß√µes
tickers <- c("F", "GM", "HMC", "STLA", "TM")

# üîΩ Obter dados dos √∫ltimos 2 anos
dados <- tq_get(tickers,
                 from = Sys.Date() - 365*2,
                 to = Sys.Date(),
                 get = "stock.prices")

# üìà Calcular os retornos logar√≠tmicos di√°rios
retornos <- dados %>%
  group_by(symbol) %>%
  tq_transmute(select = adjusted,
               mutate_fun = periodReturn,
               period = "daily",
               type = "log",
               col_rename = "retorno") %>%
  pivot_wider(names_from = symbol, values_from = retorno) %>%
  drop_na()

# üìä Matriz de retornos
matriz_retorno <- as.matrix(retornos[,-1])

# üìè Matriz de covari√¢ncia dos retornos
cov_mat <- cov(matriz_retorno)

# üìà Retornos m√©dios di√°rios
mean_returns <- colMeans(matriz_retorno)

# üîß N√∫mero de ativos
n_assets <- ncol(matriz_retorno)

# üìê Definir os inputs para o modelo de Markowitz
Dmat <- 2 * cov_mat
dvec <- rep(0, n_assets)

# üîç Verificar os retornos m√≠nimo e m√°ximo poss√≠veis

## Retorno m√≠nimo (carteira de m√≠nima vari√¢ncia)
Amat_minvar <- cbind(rep(1, n_assets), diag(1, n_assets))
bvec_minvar <- c(1, rep(0, n_assets))
sol_minvar <- solve.QP(Dmat, dvec, Amat_minvar, bvec_minvar, meq = 1)
retorno_min <- sum(sol_minvar$solution * mean_returns)

## Retorno m√°ximo (100% no ativo de maior retorno esperado)
retorno_max <- max(mean_returns)

cat("‚úÖ Retorno m√≠nimo poss√≠vel:", round(retorno_min, 6), "\n")
cat("‚úÖ Retorno m√°ximo poss√≠vel:", round(retorno_max, 6), "\n")

# üö© Defina o retorno alvo dentro desse intervalo
target_return <- 0.0005  # Ajuste aqui conforme desejado

if(target_return < retorno_min | target_return > retorno_max) {
  stop("‚ùå O retorno alvo est√° fora dos limites vi√°veis. Ajuste o target_return.")
}

# üèóÔ∏è Definir as restri√ß√µes
Amat <- cbind(rep(1, n_assets), mean_returns, diag(1, n_assets))
bvec <- c(1, target_return, rep(0, n_assets))

# üöÄ Resolver o problema quadr√°tico
sol <- solve.QP(Dmat, dvec, Amat, bvec, meq = 2)

# üîé Pesos √≥timos
pesos_otimos <- sol$solution
nomes_ativos <- colnames(matriz_retorno)

resultado_pesos <- tibble(
  Acao = nomes_ativos,
  Peso = round(pesos_otimos, 4)
)

resultado_pesos


```

```{r}
# Plotar os pesos com a mesma cor de fundo do documento
resultado_pesos %>%
  ggplot(aes(x = reorder(Acao, Peso), y = Peso, fill = Acao)) +
  geom_col(alpha = 0.9, width = 0.7) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent, 
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_viridis_d(option = "plasma", begin = 0.2, end = 0.9) +
  labs(title = "Pesos √ìtimos da Carteira",
       subtitle = "Distribui√ß√£o percentual por a√ß√£o",
       x = "A√ß√£o",
       y = "Peso (%)",
       fill = "A√ß√£o") +
  theme_void() +
  theme(
    # Fundo igual ao documento (#1a1a1a)
    plot.background = element_rect(fill = "#1a1a1a", color = NA),
    panel.background = element_rect(fill = "#1a1a1a", color = NA),
    
    # Texto branco para contraste
    text = element_text(color = "white"),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, 
                              margin = margin(b = 10), color = "white"),
    plot.subtitle = element_text(size = 12, hjust = 0.5, 
                                 margin = margin(b = 20), color = "grey80"),
    
    # Eixos
    axis.text.x = element_text(size = 11, color = "white"),
    axis.text.y = element_text(size = 11, color = "white"),
    axis.title.x = element_text(size = 12, margin = margin(t = 15), color = "white"),
    axis.title.y = element_text(size = 12, margin = margin(r = 15), color = "white"),
    
    # Grid sutil
    panel.grid.major.x = element_line(color = "grey40", linewidth = 0.3),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    
    # Legenda
    legend.background = element_rect(fill = "#1a1a1a", color = NA),
    legend.text = element_text(color = "white", size = 10),
    legend.title = element_text(color = "white", size = 11, face = "bold"),
    legend.key = element_rect(fill = "#1a1a1a", color = NA),
    legend.position = "right",
    legend.margin = margin(l = 20),
    
    # Margens
    plot.margin = margin(20, 20, 20, 20)
  )

```

```{r , include=FALSE}

# Pacotes
library(tidyquant)
library(dplyr)
library(ggplot2)
library(tidyr)

# üîó A√ß√µes da carteira (excluindo STLA)
tickers <- c("F", "GM", "HMC", "TM")

# üìÖ Per√≠odo hist√≥rico
dados <- tq_get(tickers,
                from = "2020-01-01",
                to = Sys.Date(),
                get = "stock.prices")

# üìà Calcular retornos di√°rios
retornos <- dados %>%
  group_by(symbol) %>%
  tq_transmute(select = adjusted,
               mutate_fun = periodReturn,
               period = "daily",
               col_rename = "retorno")

# üéØ Calcular m√©tricas de cada a√ß√£o
metricas_acao <- retornos %>%
  group_by(symbol) %>%
  summarise(
    retorno_medio = mean(retorno),
    volatilidade = sd(retorno),
    sharpe_simples = retorno_medio / volatilidade
  )

# üëá Criar os 3 cen√°rios: pessimista, realista, otimista
cenarios <- metricas_acao %>%
  mutate(
    retorno_pessimista = retorno_medio - volatilidade,
    retorno_realista = retorno_medio,
    retorno_otimista = retorno_medio + volatilidade
  ) %>%
  select(symbol, starts_with("retorno"), volatilidade, sharpe_simples)

print(cenarios)


```

```{r}

# üì¶ Pacotes
library(tidyquant)
library(dplyr)
library(gt)

# üîó A√ß√µes da carteira (exceto STLA que tem peso zero)
tickers <- c("F", "GM", "HMC", "TM")

# üìÖ Dados de pre√ßo
dados <- tq_get(tickers,
                from = "2020-01-01",
                to = Sys.Date(),
                get = "stock.prices")

# üìà Calcular retornos di√°rios
retornos <- dados %>%
  group_by(symbol) %>%
  tq_transmute(select = adjusted,
               mutate_fun = periodReturn,
               period = "daily",
               col_rename = "retorno")

# üéØ Calcular retorno m√©dio e volatilidade di√°ria
metricas <- retornos %>%
  group_by(symbol) %>%
  summarise(
    retorno_diario = mean(retorno, na.rm = TRUE),
    volatilidade_diaria = sd(retorno, na.rm = TRUE)
  ) %>%
  mutate(
    retorno_mensal = retorno_diario * 21,
    volatilidade_mensal = volatilidade_diaria * sqrt(21),
    
    retorno_anual = retorno_diario * 252,
    volatilidade_anual = volatilidade_diaria * sqrt(252),
    
    retorno_5anos = retorno_anual * 5,
    volatilidade_5anos = volatilidade_anual * sqrt(5)
  )

# üí∞ Simular cen√°rios para cada horizonte
investimento <- 1000

cenarios <- metricas %>%
  mutate(
    # Mensal
    pess_mensal = investimento * (1 + (retorno_mensal - volatilidade_mensal)),
    real_mensal = investimento * (1 + retorno_mensal),
    otim_mensal = investimento * (1 + (retorno_mensal + volatilidade_mensal)),
    
    # Anual
    pess_anual = investimento * (1 + (retorno_anual - volatilidade_anual)),
    real_anual = investimento * (1 + retorno_anual),
    otim_anual = investimento * (1 + (retorno_anual + volatilidade_anual)),
    
    # 5 anos
    pess_5anos = investimento * (1 + (retorno_5anos - volatilidade_5anos)),
    real_5anos = investimento * (1 + retorno_5anos),
    otim_5anos = investimento * (1 + (retorno_5anos + volatilidade_5anos))
  ) %>%
  select(symbol,
         pess_mensal, real_mensal, otim_mensal,
         pess_anual, real_anual, otim_anual,
         pess_5anos, real_5anos, otim_5anos)


```

```{r}

# TABELA MENSAL
tabela_mensal <- cenarios %>%
  select(symbol, pess_mensal, real_mensal, otim_mensal) %>%
  gt() %>%
  tab_header(
    title = md("**Simula√ß√£o de Retorno Mensal (21 dias √∫teis)**"),
    subtitle = "Investindo US$1.000 por a√ß√£o"
  ) %>%
  fmt_currency(
    columns = 2:4,
    currency = "USD"
  ) %>%
  cols_label(
    symbol = "A√ß√£o",
    pess_mensal = "üîª Pessimista",
    real_mensal = "üî∏ Realista",
    otim_mensal = "üî∫ Otimista"
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white")
    ),
    locations = cells_body()
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "bold")
    ),
    locations = list(
      cells_column_labels(everything()),
      cells_title(groups = "title"),
      cells_title(groups = "subtitle")
    )
  ) %>%
  opt_table_font(
    font = list(gt::google_font("Roboto Mono"))
  )

tabela_mensal


```

```{r}

# TABELA ANUAL
tabela_anual <- cenarios %>%
  select(symbol, pess_anual, real_anual, otim_anual) %>%
  gt() %>%
  tab_header(
    title = md("**Simula√ß√£o de Retorno Anual (252 dias √∫teis)**"),
    subtitle = "Investindo US$1.000 por a√ß√£o"
  ) %>%
  fmt_currency(
    columns = 2:4,
    currency = "USD"
  ) %>%
  cols_label(
    symbol = "A√ß√£o",
    pess_anual = "üîª Pessimista",
    real_anual = "üî∏ Realista",
    otim_anual = "üî∫ Otimista"
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white")
    ),
    locations = cells_body()
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "bold")
    ),
    locations = list(
      cells_column_labels(everything()),
      cells_title(groups = "title"),
      cells_title(groups = "subtitle")
    )
  ) %>%
  opt_table_font(
    font = list(gt::google_font("Roboto Mono"))
  )

tabela_anual


```

```{r}

# TABELA 5 ANOS
tabela_5anos <- cenarios %>%
  select(symbol, pess_5anos, real_5anos, otim_5anos) %>%
  gt() %>%
  tab_header(
    title = md("**Simula√ß√£o de Retorno em 5 Anos**"),
    subtitle = "Investindo US$1.000 por a√ß√£o"
  ) %>%
  fmt_currency(
    columns = 2:4,
    currency = "USD"
  ) %>%
  cols_label(
    symbol = "A√ß√£o",
    pess_5anos = "üîª Pessimista",
    real_5anos = "üî∏ Realista",
    otim_5anos = "üî∫ Otimista"
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white")
    ),
    locations = cells_body()
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "black"),
      cell_text(color = "white", weight = "bold")
    ),
    locations = list(
      cells_column_labels(everything()),
      cells_title(groups = "title"),
      cells_title(groups = "subtitle")
    )
  ) %>%
  opt_table_font(
    font = list(gt::google_font("Roboto Mono"))
  )

tabela_5anos


```